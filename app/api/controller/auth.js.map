{
    "version": 3,
    "sources": [
        "..\\..\\..\\src\\api\\controller\\auth.js"
    ],
    "names": [
        "Base",
        "require",
        "rp",
        "module",
        "exports",
        "loginByWeixinAction",
        "code",
        "post",
        "currentTime",
        "parseInt",
        "Date",
        "getTime",
        "clientIp",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "js_code",
        "secret",
        "think",
        "config",
        "appid",
        "sessionData",
        "JSON",
        "parse",
        "openid",
        "fail",
        "userId",
        "model",
        "where",
        "weixin_openid",
        "getField",
        "is_new",
        "buffer",
        "Buffer",
        "from",
        "nickname",
        "toString",
        "isEmpty",
        "add",
        "username",
        "uuid",
        "password",
        "register_time",
        "register_ip",
        "last_login_time",
        "last_login_ip",
        "mobile",
        "avatar",
        "user_id",
        "id",
        "update",
        "newUserInfo",
        "field",
        "find",
        "TokenSerivce",
        "service",
        "sessionKey",
        "create",
        "success",
        "token",
        "userInfo",
        "logoutAction"
    ],
    "mappings": "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",
    "file": "..\\..\\..\\src\\api\\controller\\auth.js",
    "sourcesContent": [
        "const Base = require(\"./base.js\");\r\nconst rp = require(\"request-promise\");\r\nmodule.exports = class extends Base {\r\n  async loginByWeixinAction() {\r\n    // const code = this.post('code');\r\n    const code = this.post(\"code\");\r\n    let currentTime = parseInt(new Date().getTime() / 1000);\r\n    const clientIp = \"\"; // 暂时不记录 ip test git\r\n    // 获取openid\r\n    const options = {\r\n      method: \"GET\",\r\n      url: \"https://api.weixin.qq.com/sns/jscode2session\",\r\n      qs: {\r\n        grant_type: \"authorization_code\",\r\n        js_code: code,\r\n        secret: think.config(\"weixin.secret\"),\r\n        appid: think.config(\"weixin.appid\"),\r\n      },\r\n    };\r\n    let sessionData = await rp(options);\r\n    sessionData = JSON.parse(sessionData);\r\n    if (!sessionData.openid) {\r\n      return this.fail(\"登录失败，openid无效\");\r\n    }\r\n    // 根据openid查找用户是否已经注册\r\n    let userId = await this.model(\"user\")\r\n      .where({\r\n        weixin_openid: sessionData.openid,\r\n      })\r\n      .getField(\"id\", true);\r\n    let is_new = 0;\r\n    const buffer = Buffer.from('微信用户');\r\n    let nickname = buffer.toString(\"base64\");\r\n    if (think.isEmpty(userId)) {\r\n      // 注册\r\n      userId = await this.model(\"user\").add({\r\n        username: \"微信用户\" + think.uuid(6),\r\n        password: sessionData.openid,\r\n        register_time: currentTime,\r\n        register_ip: clientIp,\r\n        last_login_time: currentTime,\r\n        last_login_ip: clientIp,\r\n        mobile: \"\",\r\n        weixin_openid: sessionData.openid,\r\n        nickname: nickname,\r\n        avatar:'/static/images/default_avatar.png'\r\n      });\r\n      is_new = 1;\r\n    }\r\n    sessionData.user_id = userId;\r\n    // 更新登录信息\r\n    await this.model(\"user\")\r\n      .where({\r\n        id: userId,\r\n      })\r\n      .update({\r\n        last_login_time: currentTime,\r\n        last_login_ip: clientIp,\r\n      });\r\n    const newUserInfo = await this.model(\"user\")\r\n      .field(\"id,username,nickname, avatar\")\r\n      .where({\r\n        id: userId,\r\n      })\r\n      .find();\r\n    newUserInfo.nickname = Buffer.from(\r\n      newUserInfo.nickname,\r\n      \"base64\"\r\n    ).toString();\r\n    const TokenSerivce = this.service(\"token\", \"api\");\r\n    const sessionKey = await TokenSerivce.create(sessionData);\r\n    if (think.isEmpty(newUserInfo) || think.isEmpty(sessionKey)) {\r\n      return this.fail(\"登录失败4\");\r\n    }\r\n    return this.success({\r\n      token: sessionKey,\r\n      userInfo: newUserInfo,\r\n      is_new: is_new,\r\n    });\r\n  }\r\n  async logoutAction() {\r\n    return this.success();\r\n  }\r\n};\r\n"
    ]
}